/**
 * PaymentInterface - Shows specific payment methods and interfaces
 * Handles QRIS QR codes, Virtual Account details, E-Wallet redirects, etc.
 */

import React, { useEffect, useState } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { QrCode, Copy, Clock, CreditCard, Building2, Smartphone, CheckCircle, AlertCircle, ArrowLeft } from 'lucide-react';
import { PNContainer, PNCard, PNHeading, PNText, PNButton } from '../components/ui/PinkNeonDesignSystem';
import QRCode from 'react-qr-code';
import '../styles/PaymentAnimations.css';

interface PaymentData {
  id: string;
  payment_method: string;
  amount: number;
  currency: string;
  status: string;
  external_id: string;
  created: string;
  expiry_date?: string;
  
  // QRIS specific
  qr_string?: string;
  qr_url?: string;
  
  // Virtual Account specific
  account_number?: string;
  bank_code?: string;
  
  // E-Wallet specific
  payment_url?: string;
  action_type?: string;
  
  // Retail specific
  payment_code?: string;
  retail_outlet?: string;
  
  // Order info
  description?: string;
}

const PaymentInterface: React.FC = () => {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const [paymentData, setPaymentData] = useState<PaymentData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [copying, setCopying] = useState<string | null>(null);
  const [polling, setPolling] = useState(false);
  const [justPaid, setJustPaid] = useState(false);
  const [currentTime, setCurrentTime] = useState(new Date());

  const paymentId = searchParams.get('id');
  const paymentMethod = searchParams.get('method');

  useEffect(() => {
    if (!paymentId) {
      setError('Payment ID tidak ditemukan');
      setLoading(false);
      return;
    }

  fetchPaymentData();
  }, [paymentId]);

  // Update timer every second
  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentTime(new Date());
    }, 1000);

    return () => clearInterval(interval);
  }, []);

  const fetchPaymentData = async () => {
    try {
      const response = await fetch(`/api/xendit/get-payment?id=${paymentId}`);
      
      if (!response.ok) {
        throw new Error('Payment not found');
      }
      
      const data = await response.json();
      setPaymentData(data);

      // If payment already paid, show success state briefly then redirect
  if (data.status && ['PAID', 'paid', 'SETTLED', 'COMPLETED', 'completed', 'SUCCEEDED', 'SUCCESS'].includes(String(data.status).toUpperCase())) {
        setJustPaid(true);
        setTimeout(() => {
          navigate(`/payment-status?status=success&id=${encodeURIComponent(data.id)}`);
        }, 2500);
        return;
      }

      // Start polling until paid
      if (!polling) {
        setPolling(true);
        const interval = setInterval(async () => {
          try {
            const r = await fetch(`/api/xendit/get-payment?id=${paymentId}`);
            if (r.ok) {
              const d = await r.json();
              setPaymentData(d);
              if (d.status && ['PAID', 'paid', 'SETTLED', 'COMPLETED', 'completed', 'SUCCEEDED', 'SUCCESS'].includes(String(d.status).toUpperCase())) {
                clearInterval(interval);
                setJustPaid(true);
                setTimeout(() => {
                  navigate(`/payment-status?status=success&id=${encodeURIComponent(d.id)}`);
                }, 2500);
              }
            }
          } catch {}
        }, 5000);

        // cleanup
        return () => clearInterval(interval);
      }
    } catch (err) {
      console.error('Failed to fetch payment data:', err);
      setError('Gagal memuat data pembayaran');
    } finally {
      setLoading(false);
    }
  };

  const copyToClipboard = async (text: string, type: string) => {
    try {
      setCopying(type);
      await navigator.clipboard.writeText(text);
      setTimeout(() => setCopying(null), 2000);
    } catch (err) {
      alert('Gagal menyalin');
    }
  };

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0
    }).format(amount);
  };

  const getTimeRemaining = () => {
    if (!paymentData?.expiry_date) return 'Tidak ada batas waktu';
    
    const now = currentTime.getTime();
    const expiry = new Date(paymentData.expiry_date).getTime();
    const diff = expiry - now;
    
    if (diff <= 0) return 'Kedaluwarsa';
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
      return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
  };

  const checkPaymentExpiry = () => {
    if (!paymentData?.expiry_date) return false;
    
    const now = currentTime.getTime();
    const expiry = new Date(paymentData.expiry_date).getTime();
    
    return now >= expiry;
  };

  const getTimeRemainingMinutes = () => {
    if (!paymentData?.expiry_date) return null;
    
    const now = currentTime.getTime();
    const expiry = new Date(paymentData.expiry_date).getTime();
    const diff = expiry - now;
    
    if (diff <= 0) return 0;
    
    return Math.floor(diff / (1000 * 60));
  };

  const isTimeRunningOut = () => {
    const minutes = getTimeRemainingMinutes();
    return minutes !== null && minutes <= 5 && minutes > 0;
  };

  // Check for expiry and redirect when payment expires
  useEffect(() => {
    if (!paymentData?.expiry_date) return;

    const interval = setInterval(() => {
      if (checkPaymentExpiry()) {
        console.log('[Payment Interface] Payment expired, redirecting to failed status');
        navigate(`/payment-status?status=expired&id=${encodeURIComponent(paymentData.id)}&reason=expired`);
      }
    }, 1000);

    return () => clearInterval(interval);
  }, [paymentData, navigate]);

  if (loading) {
    return (
      <div className="min-h-screen bg-black text-white flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-400 mx-auto mb-4"></div>
          <PNText>Memuat pembayaran...</PNText>
        </div>
      </div>
    );
  }

  if (error || !paymentData) {
    return (
      <div className="min-h-screen bg-black text-white flex items-center justify-center">
        <PNContainer>
          <div className="text-center">
            <AlertCircle className="text-red-400 mx-auto mb-4" size={48} />
            <PNHeading level={2} className="mb-4">Pembayaran Tidak Ditemukan</PNHeading>
            <PNText className="mb-6">{error}</PNText>
            <PNButton onClick={() => navigate('/')}>Kembali ke Beranda</PNButton>
          </div>
        </PNContainer>
      </div>
    );
  }

  const renderPaymentMethod = () => {
    const method = (paymentMethod || paymentData.payment_method || '').toLowerCase();

  // Enhanced QRIS Payment with Animations
    if (method === 'qris' && (paymentData.qr_string || paymentData.qr_url)) {
      const qrValue = paymentData.qr_string || paymentData.qr_url || '';
      return (
        <div className="space-y-8 animate-fadeIn">
          {/* Enhanced QRIS Header with Gradient Animation */}
          <div className="bg-gradient-to-r from-orange-500/20 via-red-500/20 to-orange-500/20 rounded-3xl p-8 border border-orange-500/30 shadow-2xl shadow-orange-500/20 transform hover:scale-[1.02] transition-all duration-500 animate-slideUp">
            <div className="flex items-center justify-center space-x-4 mb-6">
              <div className="relative bg-gradient-to-br from-orange-500 to-red-600 p-4 rounded-2xl animate-pulse">
                <QrCode className="text-white" size={32} />
                <div className="absolute inset-0 bg-orange-500 rounded-2xl animate-ping opacity-20"></div>
              </div>
              <div className="text-center">
                <PNHeading level={3} className="text-orange-400 mb-2 animate-slideDown">Scan QR Code QRIS</PNHeading>
                <PNText className="text-gray-300 animate-fadeIn delay-200">Bayar dengan aplikasi e-wallet atau mobile banking</PNText>
              </div>
            </div>
          </div>

          {/* Enhanced QR Code Display */}
          <div className="bg-gradient-to-br from-gray-800/80 via-gray-900/80 to-black/80 rounded-3xl p-10 border border-gray-700 backdrop-blur-sm shadow-2xl animate-slideUp delay-200">
            <div className="text-center space-y-8">
              {/* QR Code with Glow Effect */}
              <div className="relative inline-block animate-zoomIn">
                <div className="bg-white p-8 rounded-3xl shadow-2xl transform hover:scale-105 transition-all duration-300 animate-glow">
                  <QRCode 
                    value={qrValue} 
                    size={300}
                    level="M"
                    className="animate-fadeIn"
                  />
                </div>
                {/* Animated border glow */}
                <div className="absolute inset-0 bg-gradient-to-r from-orange-400 via-pink-500 to-orange-400 rounded-3xl opacity-20 animate-pulse blur-lg"></div>
              </div>
              
              {/* Enhanced Instructions with Animations */}
              <div className="space-y-6 animate-slideUp delay-300">
                <div className="bg-gradient-to-r from-blue-500/10 via-purple-500/10 to-blue-500/10 rounded-2xl p-6 border border-blue-500/20 backdrop-blur-sm transform hover:scale-[1.02] transition-all duration-300">
                  <div className="flex items-center justify-center space-x-2 mb-4">
                    <span className="text-2xl animate-bounce">üì±</span>
                    <PNText className="text-blue-300 font-semibold text-lg">Cara Pembayaran</PNText>
                  </div>
                  <div className="text-left text-gray-300 space-y-3">
                    <div className="flex items-center space-x-3 p-3 rounded-lg bg-gray-800/50 transform hover:translate-x-2 transition-all duration-200">
                      <span className="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm">1</span>
                      <span>Buka aplikasi e-wallet (DANA, GoPay, OVO, LinkAja, ShopeePay)</span>
                    </div>
                    <div className="flex items-center space-x-3 p-3 rounded-lg bg-gray-800/50 transform hover:translate-x-2 transition-all duration-200 delay-75">
                      <span className="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold text-sm">2</span>
                      <span>Pilih menu Scan QR atau QRIS</span>
                    </div>
                    <div className="flex items-center space-x-3 p-3 rounded-lg bg-gray-800/50 transform hover:translate-x-2 transition-all duration-200 delay-150">
                      <span className="w-8 h-8 bg-pink-500 text-white rounded-full flex items-center justify-center font-bold text-sm">3</span>
                      <span>Arahkan kamera ke QR code di atas</span>
                    </div>
                    <div className="flex items-center space-x-3 p-3 rounded-lg bg-gray-800/50 transform hover:translate-x-2 transition-all duration-200 delay-225">
                      <span className="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold text-sm">4</span>
                      <span>Konfirmasi pembayaran di aplikasi</span>
                    </div>
                  </div>
                </div>

                <div className="bg-gradient-to-r from-green-500/10 via-emerald-500/10 to-green-500/10 rounded-2xl p-6 border border-green-500/20 backdrop-blur-sm animate-pulse">
                  <div className="flex items-center justify-center space-x-2 mb-2">
                    <span className="text-2xl animate-bounce delay-100">‚úÖ</span>
                    <PNText className="text-green-300 font-semibold">Pembayaran akan otomatis dikonfirmasi</PNText>
                  </div>
                  <PNText className="text-sm text-gray-400 animate-fadeIn delay-500">Halaman ini akan diperbarui setelah pembayaran berhasil</PNText>
                </div>
              </div>

              {/* Enhanced Copy QR Button */}
              <button
                onClick={() => copyToClipboard(qrValue, 'qr')}
                className="inline-flex items-center space-x-3 bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500 text-white px-6 py-3 rounded-xl border border-gray-600 transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl animate-slideUp delay-400"
              >
                {copying === 'qr' ? (
                  <>
                    <CheckCircle className="text-green-400 animate-bounce" size={20} />
                    <span className="font-medium">QR Code Disalin!</span>
                  </>
                ) : (
                  <>
                    <Copy className="text-gray-400 group-hover:text-white transition-colors" size={20} />
                    <span className="font-medium">Salin QR Code</span>
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Virtual Account Payment
  if (['bca', 'bni', 'mandiri', 'bri', 'cimb', 'permata', 'bjb', 'bsi'].includes(method) && paymentData.account_number) {
      const bankName = {
        bca: 'BCA',
        bni: 'BNI',
        mandiri: 'Mandiri',
        bri: 'BRI',
    cimb: 'CIMB Niaga',
    permata: 'Permata',
    bjb: 'BJB',
    bsi: 'BSI'
      }[method] || method.toUpperCase();

      return (
        <PNCard className="space-y-4">
          <div className="flex items-center space-x-2 mb-4">
            <Building2 className="text-blue-400" size={24} />
            <PNHeading level={3}>Transfer Bank {bankName}</PNHeading>
          </div>

          <div className="bg-gray-800 p-4 rounded-lg space-y-3">
            <div className="flex justify-between items-center">
              <PNText className="text-sm text-gray-300">Nomor Virtual Account:</PNText>
              <div className="flex items-center space-x-2">
                <PNText className="font-mono text-lg font-bold">{paymentData.account_number}</PNText>
                <button
                  onClick={() => copyToClipboard(paymentData.account_number!, 'va')}
                  className="p-1 hover:bg-gray-700 rounded transition-colors"
                >
                  {copying === 'va' ? (
                    <CheckCircle className="text-green-400" size={16} />
                  ) : (
                    <Copy className="text-gray-400" size={16} />
                  )}
                </button>
              </div>
            </div>

            <div className="flex justify-between items-center">
              <PNText className="text-sm text-gray-300">Jumlah Transfer:</PNText>
              <PNText className="font-bold text-lg">{formatCurrency(paymentData.amount)}</PNText>
            </div>
          </div>

          <div className="space-y-2 text-sm text-gray-300">
            <PNText>Cara transfer:</PNText>
            <ol className="list-decimal list-inside space-y-1 ml-4">
              <li>Buka aplikasi mobile banking atau ATM {bankName}</li>
              <li>Pilih menu Transfer / Transfer Virtual Account</li>
              <li>Masukkan nomor Virtual Account di atas</li>
              <li>Masukkan jumlah transfer sesuai nominal</li>
              <li>Konfirmasi dan selesaikan pembayaran</li>
            </ol>
          </div>
        </PNCard>
      );
    }

    // E-Wallet Payment
    if (['dana', 'gopay', 'linkaja', 'shopeepay', 'ovo'].includes(method) && paymentData.payment_url) {
      const walletName = {
        dana: 'DANA',
        gopay: 'GoPay',
        linkaja: 'LinkAja',
        shopeepay: 'ShopeePay',
        ovo: 'OVO'
      }[method] || method.toUpperCase();

      return (
        <PNCard className="text-center space-y-4">
          <div className="flex items-center justify-center space-x-2 mb-4">
            <Smartphone className="text-green-400" size={24} />
            <PNHeading level={3}>Pembayaran {walletName}</PNHeading>
          </div>

          <div className="space-y-4">
            <PNText className="text-gray-300">
              Klik tombol di bawah untuk melanjutkan pembayaran melalui aplikasi {walletName}
            </PNText>

            <PNButton
              onClick={() => window.open(paymentData.payment_url, '_blank')}
              className="bg-green-500 hover:bg-green-600 text-white px-8 py-3"
              size="lg"
            >
              Buka {walletName}
            </PNButton>

            <PNText className="text-sm text-gray-400">
              Anda akan diarahkan ke aplikasi {walletName} untuk menyelesaikan pembayaran
            </PNText>
          </div>
        </PNCard>
      );
    }

    // Fallback for unknown payment methods
    return (
      <PNCard className="text-center space-y-4">
        <CreditCard className="text-gray-400 mx-auto" size={48} />
        <PNHeading level={3}>Metode Pembayaran: {paymentData.payment_method.toUpperCase()}</PNHeading>
        <PNText className="text-gray-300">
          Silakan ikuti instruksi pembayaran yang diberikan
        </PNText>
      </PNCard>
    );
  };

  return (
    <div className="min-h-screen animated-bg text-white">
      <PNContainer className="py-8 animate-fadeIn">
        {justPaid && (
          <div className="mb-6 flex items-center justify-center animate-slideDown">
            <div className="inline-flex items-center space-x-3 bg-gradient-to-r from-green-500/20 to-emerald-500/20 text-green-400 px-6 py-3 rounded-full border border-green-500/30 backdrop-blur-sm shadow-lg animate-pulse">
              <div className="relative">
                <div className="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                <div className="absolute inset-0 w-3 h-3 bg-green-400 rounded-full animate-ping opacity-75"></div>
              </div>
              <span className="font-medium">Pembayaran berhasil! Mengarahkan...</span>
            </div>
          </div>
        )}
        
        {/* Enhanced Header with Animation */}
        <div className="flex items-center justify-between mb-8 animate-slideDown">
          <button 
            onClick={() => navigate(-1)}
            className="flex items-center space-x-3 text-gray-300 hover:text-white transition-all duration-300 transform hover:scale-105 hover:translate-x-1 group"
          >
            <div className="p-2 rounded-lg bg-gray-800/50 group-hover:bg-gray-700/50 transition-all duration-300">
              <ArrowLeft size={20} className="group-hover:animate-bounce" />
            </div>
            <span className="font-medium">Kembali</span>
          </button>

          {paymentData.expiry_date && (
            <div className={`flex items-center space-x-3 px-4 py-3 rounded-lg border ${
              isTimeRunningOut() 
                ? 'bg-red-50 text-red-600 border-red-300' 
                : 'bg-orange-50 text-orange-600 border-orange-300'
            }`}>
              <Clock size={20} />
              <div>
                <div className="text-sm font-medium">Sisa Waktu</div>
                <div className="font-mono font-bold text-lg">
                  {getTimeRemaining()}
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Payment Summary - SIMPLIFIED */}
        <div className="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
          <div className="text-center space-y-4">
            <div className="inline-flex items-center justify-center w-16 h-16 bg-pink-500 rounded-full mb-4">
              <CreditCard className="text-white" size={28} />
            </div>
            
            <div className="space-y-2">
              <PNHeading level={2} className="text-gray-100">Total Pembayaran</PNHeading>
              <div className="text-4xl font-bold text-white">
                {formatCurrency(paymentData.amount)}
              </div>
              <PNText className="text-gray-300">{paymentData.description}</PNText>
            </div>
            
            {/* Status */}
            <div className="inline-flex items-center space-x-3 bg-yellow-500/20 text-yellow-300 px-6 py-3 rounded-full border border-yellow-500/30">
              <div className="w-3 h-3 bg-yellow-400 rounded-full"></div>
                <div className="absolute inset-0 w-4 h-4 bg-yellow-400 rounded-full animate-ping opacity-75"></div>
              <span className="font-semibold">Menunggu Pembayaran</span>
            </div>

            {/* Payment Method */}
            <div className="inline-flex items-center space-x-2 bg-blue-500/20 text-blue-300 px-4 py-2 rounded-lg border border-blue-500/30">
              <QrCode size={16} />
              <span className="text-sm font-medium">Metode: {(paymentMethod || paymentData.payment_method || '').toUpperCase()}</span>
            </div>
          </div>
        </div>

        {/* Time Warning - SIMPLIFIED */}
        {isTimeRunningOut() && (
          <div className="mb-6 bg-red-500/20 border border-red-500/30 rounded-lg p-4">
            <div className="flex items-center space-x-3">
              <div className="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                <Clock className="text-white" size={18} />
              </div>
              <div>
                <div className="text-red-400 font-bold text-lg">Waktu Hampir Habis!</div>
                <div className="text-red-300 text-sm">Segera selesaikan pembayaran sebelum kedaluwarsa</div>
              </div>
            </div>
          </div>
        )}
              </div>
              <div className="flex-1">
                <div className="flex items-center space-x-2 mb-2">
                  <span className="text-2xl animate-bounce">‚ö†Ô∏è</span>
                  <PNText className="text-red-400 font-bold text-lg animate-pulse">Waktu Hampir Habis!</PNText>
                </div>
                <PNText className="text-gray-300 animate-fadeIn">
                  Silakan selesaikan pembayaran sebelum waktu habis untuk menghindari pembatalan otomatis.
                </PNText>
              </div>
            </div>
            
            {/* Animated Progress Bar */}
            <div className="mt-4 bg-gray-800 rounded-full h-2 overflow-hidden">
              <div className={`h-full bg-gradient-to-r from-red-500 to-pink-500 animate-pulse transition-all duration-1000 ${
                getTimeRemainingMinutes() <= 2 ? 'w-1/4' : 
                getTimeRemainingMinutes() <= 3 ? 'w-1/2' : 'w-3/4'
              }`}></div>
            </div>
          </div>
        )}

        {/* Payment Method Interface */}
        {renderPaymentMethod()}

        {/* Enhanced Footer Info with Animation */}
        <div className="mt-10 bg-gradient-to-r from-gray-800/50 via-gray-900/50 to-gray-800/50 rounded-2xl p-6 border border-gray-700/50 backdrop-blur-sm animate-slideUp delay-500">
          <div className="text-center space-y-4">
            <div className="flex items-center justify-center space-x-2 mb-3">
              <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
              <PNText className="text-gray-300 font-medium">Sistem Monitoring Aktif</PNText>
              <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse delay-100"></div>
            </div>
            
            <PNText className="text-gray-300 animate-fadeIn delay-300">
              Pembayaran akan dikonfirmasi secara otomatis
            </PNText>
            <PNText className="text-sm text-gray-400 animate-fadeIn delay-400">
              Halaman ini akan diperbarui setelah pembayaran berhasil
            </PNText>
            
            <div className="flex items-center justify-center space-x-2 pt-3 border-t border-gray-700/50">
              <span className="text-sm text-gray-400 animate-fadeIn delay-500">Butuh bantuan?</span>
              <a 
                href="https://wa.me/6289653510125" 
                target="_blank" 
                rel="noopener noreferrer"
                className="text-sm text-pink-400 hover:text-pink-300 transform hover:scale-105 transition-all duration-200 animate-fadeIn delay-600"
              >
                Hubungi Customer Service
              </a>
            </div>
          </div>
        </div>
      </PNContainer>
    </div>
  );
};

export default PaymentInterface;
